<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="initial-scale=1, maximum-scale=1, user-scalable=no, width=device-width">
<title></title>
<link rel="stylesheet" type="text/css" href="chosen.css">
</head>
<style>
body {
  font-family: "roboto", Helvetica, Arial, sans-serif;
  position: relative;
/*  width: 960px;
*/}

.axis text {
  font: 10px sans-serif;
}

.axis path,
.axis line {
  fill: none;
  stroke:white;
  shape-rendering: crispEdges;
}

.bar {
/*  fill: steelblue;
*/  fill-opacity: .9;
}

.x.axis path {
  display: none;
}

label {
  position: absolute;
  top: 10px;
  right: 10px;
}

.dot{
	fill:white;
/*	stroke:#EEA1CD;
*/}


.avg_line{
	stroke: 3px solid black
}

#graphic {
    position: fixed;
    top: 0px;
    z-index: 998;
  }

  #sections {
    position: relative;
    margin: 50px auto;  
    top: 260px;
    z-index: 90;
    width:50%;
  }

  .section{
    width: 280px;
    height: 300px;
  background-color: rgba(255,255,255,0.8)
	margin-bottom:240px;
  }

  .step {
      margin-bottom: 500px;
    }

    .highlight{
    	fill:#eee !important;
    }
    .y.axis text{
    	display: none;
    } 

    .tx_highlight{
    	background-color: #0661A2;
    	color:white;
    	border-radius: 3px;
    	padding:2px;
    	margin: 2px;
    }

    .bar{
        box-shadow: 0em 2em 3em #fff;

    }

    .grid .tick {
	    stroke: lightgrey;
	    stroke-opacity: 0.7;
	    shape-rendering: crispEdges;
	    stroke-dasharray: 2;
	}

	.grid path {
	    stroke-width: 0;
	}

	.gradient_top{
		background-color: white;
	    height: 100px;
	    position: fixed;
	    top: 0px;
	    width: 100%;
	    z-index: 91;
	    box-shadow: 0em 2em 3em #fff;

	}

	.lg{
		float:left;
		width:40px;
		height:10px;
		margin-right:10px;
	}

	.lg-col-1{
		background-color: #FFD685;
	}

	.lg-col-2{
		background-color: #FFBB33;
	}

	.lg-col-3{
		background-color: #FFAA00;
	}

	.lg-col-4{
		background-color: #D78F00;
	}
	.lg-col-5{
		background-color: #A66F00;
	}

	.legend{
		margin-top: 10px;
	}
	.cf{
		clear:both;
	}

	.lg-text{
		font-size:8px;
	}

	.chosen-container-single .chosen-single {
	    position: relative;
	    display: block;
	    overflow: hidden;
	    padding: 4px 0 0 20px;
	    height: 32px;
	    border-bottom: 2px solid #5696E9;
	    border-top: 0px solid #5696E9;
	    border-left: 0px solid #5696E9;
	    border-right: 0px solid #5696E9;

	    /* border-top: 2px solid #5696E9; */
	    border-radius: 2px;
	    text-decoration: none;
	    white-space: nowrap;
	    line-height: 24px;
	     background: rgba(0,0,0,.02); 
	    color: #444;
	}

	.dropdown{
		margin-top: 20px;
		max-width: 300px;
		margin-left: auto;
		margin-right: auto;
	}

	.sb_hed{
		color:grey;
		font-size: 10px;
	}

	.tb_hed{
		color:#666;
		font-size:14px;
	}

	.nb{
		font-size: 12px;
	}

	.tb{
		margin-top: 10px;
		margin-bottom: 10px;
	}

	table{
		border-collapse: collapse;

	}
	table, th, td {
   		border-bottom: 1px solid #ddd;
   		padding:4px;
	}

	.tb-an{
		margin-top: 20px;
		font-size: 14px;
		font-weight: bold;
	}

	.fl-ex{
		color:#AA3939;
		font-size: 20px;
	}

	.fl-chp{
		color:#226666;
		font-size: 20px;
	}

	.source{
		font-size: 10px;
		font-style: oblique;
	}



</style>
<body>
<div class="gradient_top"></div>
<div id="sections">
    <section class="section step" id="section1">
      <h1>How much do hospitals charge?</h1>
      Lorem ipsum dolor sit amet, consectetur adipisicing elit, sed do eiusmod
      tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam,
      quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo
      consequat. Duis aute irure dolor in reprehenderit in voluptate velit esse
      cillum dolore eu fugiat nulla pariatur. Excepteur sint occaecat cupidatat non
      proident, sunt in culpa qui officia deserunt mollit anim id est laborum.
    </section>
    <section class="section step" id="section2">
      <div class="chart-hed">TKTKTKTK</div>
      On average, the most expensive hospital charges <span class="tx_highlight">3 times </span> more than an average hospital on a single procedure. 
      While you can save more than <span class="tx_highlight">12 times</span>of your money if you are treated in the least costly hospital. 
      <div class="avg-cht"></div>
    </section>
    <section class="section step" id="section3">
      <div class="chart-hed">TKTKTKTK</div>
      Lorem ipsum dolor sit amet, consectetur adipisicing elit, sed do eiusmod
      tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam,
      quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo
      consequat. Duis aute irure dolor in reprehenderit in voluptate velit esse
      cillum dolore eu fugiat nulla pariatur. 
      <div class="legend"><span class="lg lg-col-1"> </span><span class="lg lg-col-2"></span><span class="lg lg-col-3"></span><span class="lg lg-col-4"></span><span class="lg lg-col-5"></span></div>
      <div class="cf"></div>
      <div class="lg-text"><span class="lg lg-text">more than 20 times</span><span class="lg lg-text"> 10 to 20 times</span><span class="lg lg-text">5 to 10 times</span><span class="lg lg-text">3 to 5 times</span><span class="lg lg-text">less than 3 times</span></div>
     </section>
     <section class="section step" id="section4">
      <div class="chart-hed">TKTKTKTK</div>
      Lorem ipsum dolor sit amet, consectetur adipisicing elit, sed do eiusmod
      tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam,
      quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo
      consequat. Duis aute irure dolor in reprehenderit in voluptate velit esse
      cillum dolore eu fugiat nulla pariatur. 
     </section>
     <section class="section step" id="section5">
      <div class="chart-hed">Explore yourself</div>
      Hover over or search for a procedure
	    <div class="dropdown occupation">
			<div style="text-align:left; font-weight:bold; margin-bottom:10px;">If you need a  </div>
		    <select class="chosen occ-name" data-placeholder="Choose an occupation"><option value=""></option></select>
		</div>
	    <table class="tb tp-tb">
	    <div class="tb-an">
		    <div>Most expensive hospital: <span class="fl-ex"></span></div>
		    <div>Number of cases:<span class="fl-ex-cs"></span></div>
		</div>
	    <tr>
	    	<th class="tb_hed" colspan="2">Avg. amount hospital billed Medicare</th><th class="tb_hed" colspan="2">Avg. amount paid by Medicare</th>
	    </tr>
	    <tr>
	    	<td class="sb_hed">AMOUNT</td><td class="sb_hed">VS. U.S. AVG.</td>
	    	<td class="sb_hed">AMOUNT</td><td class="sb_hed">VS. U.S. AVG.</td>
	    </tr>
	    <tr>
	    	<td class="nb fl-ex-money">??</td><td class="nb fl-ex-money-avg">??</td>
	    	<td class="nb fl-ex-pay">??</td><td class="nb fl-ex-pay-avg">??</td>

	    </tr>
	    </table>
	    <table class="tb lw-tb">
	    <div class="tb-an">
		    <div>Cheapest hospital: <span class="fl-chp"></span></div>
		    <div>Number of cases:<span class="fl-chp-cs"></span></div>
	    </div>
	    <tr>
	    	<th class="tb_hed" colspan="2">Avg. amount hospital billed Medicare</th><th class="tb_hed" colspan="2">Avg. amount paid by Medicare</th>
	    </tr>
	    <tr>
	    	<td class="sb_hed">AMOUNT</td><td class="sb_hed">VS. U.S. AVG.</td>
	    	<td class="sb_hed">AMOUNT</td><td class="sb_hed">VS. U.S. AVG.</td>
	    </tr>
	    <tr>
	    	<td class="nb fl-chp-money">??</td><td class="nb fl-chp-money-avg">??</td>
	    	<td class="nb fl-chp-pay">??</td><td class="nb fl-chp-pay-avg">??</td>
	    </tr>
	    </table>
	    <div class="source">Source: Modern Healthcare analysis of CMS data</div>
	    </section>
</div>

<div id="graphic"></div>

</body>
<script src="http://d3js.org/d3.v3.min.js"></script>
<script src="http://labratrevenge.com/d3-tip/javascripts/d3.tip.v0.6.3.js"></script>
<script src="fisheye.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/waypoints/4.0.1/noframework.waypoints.min.js"></script>
<script src="chosen.min.js"></script>
<script src="chosen.mobile.min.js"></script>
<script>
function Graph(){
		var myData=[];
		var myData2=[];


		d3.csv("data.csv", function(error, data){
			data.forEach(function(d,i){
				var d1 = JSON.parse(JSON.stringify(d));
				if (!d1.charges_min){ console.log(i);

				}

				myData.push(Object.assign(d1,{"max":+d.charges_max, "min":+d.charges_min, "avg":+d.charges_avg}));
				myData2.push(Object.assign(d1,{"max":+d.medipay_max, "min":+d.medipay_min, "avg":+d.medipay_avg}));
			});

			drawChart();

		})

		var margin = {top: 10, right:20, bottom:30, left:10},
		width = window.innerWidth *0.9,
		height = window.innerHeight ;

		var z = d3.fisheye.ordinal().rangeRoundBands([0, width - margin.right - margin.left]).distortion(0.9);

		//set up gradient colors
		var color = d3.scale.ordinal()
			.range(["#A66F00", "#D78F00","#FFAA00","#FFBB33","#FFD685"])

		var x = d3.scale.linear()
			.range([0,width]);

		var y = d3.scale.ordinal()
			.rangeBands([height, 0], .1,3)

		var xAxis = d3.svg.axis()
			.scale(x)
			.orient("top");

		var yAxis = d3.svg.axis()
			.scale(y)
			.orient("left")
		    .outerTickSize(0)
		    .tickPadding(1);

		var svg = d3.select("#graphic").append("svg")
			.attr("class","giant_chart")
			.attr("width",width + margin.left + margin.right)
			.attr("height", height + margin.top + margin.bottom)
			.append("g")
			.attr("transform", "translate(" + margin.left + "," + margin.top + ")");

	
		function drawChart(){
		

			y.domain(myData.sort(function(a,b){
				return d3.ascending(a.max, b.max)
			}).map(function(d){return d.DRG;}))

			x.domain([0, d3.max(myData, function(d){return d.max;})])

			svg.append("g")
				.attr("class","x axis")
				.attr("transform", function(){return "translate(0," + height + ")"})
				.call(xAxis)
				.selectAll("text")
			    .attr("y", 0)
			    // .attr("x", 9)
			    .attr("dy", ".35em")
			    // .attr("transform", "rotate(90)")
			    .style("text-anchor", "start");

			svg.append("g")
				.attr("class","y axis")
				.call(yAxis)
				.append("text")
			      .attr("transform", "rotate(-90)")
			      .attr("y", 6)
			      .attr("dy", ".71em")
			      .style("text-anchor", "end")



			var bars = svg.selectAll(".bar")
		      .data(myData)
		    .enter().append("rect")
		      .attr("class", "bar")
		      .attr("y", function(d) { return y(d.DRG); })
		      .attr("height", y.rangeBand())
		      .attr("x", function(d) {
		      	if(!d.min){
		      		console.log(d);
		      	}
		      	return x(d.min)})
		      .attr("width", function(d) {return x(d.max - d.min)})
		      // .style("fill", function(d,i){
		      // 	      	if(d.max/d.min >=20){
		      // 	      		return color(0);
		      // 	      	}else if (d.max/d.min >=10 && d.max/d.min <20){
		      // 	      		return color(1);
		      // 	      	} else if (d.max/d.min<10 && d.max/d.min >5){
		      // 	      		return color(2);
		      // 	      	}else if (d.max/d.min <= 5 && d.max/d.min >3){
		      // 	      		return color(3)
		      // 	      	}else{
		      // 	      		return color(4)
		      // 	      	}
		      // 		})
		      .style("fill","lightgrey")
		      // .style("filter", "url(#drop-shadow)")

		      bars.on("mouseover",function(d,i){
			      	// $(this).css("fill","#eee")
			      	$(this).addClass("highlight");
			      	$(".fl-ex").html("</br>" + d.provider_name_max + ", " + d.provider_state_max)
			      	$(".fl-ex-cs").html(d.discharges_max)
			      	$(".fl-chp").html("</br>" + d.provider_name_min + ", " + d.provider_state_min)
			      	$(".fl-chp-cs").html(d.discharges_min)
			      	$(".fl-ex-money").html("$" +numberWithCommas(d.max))
			      	$(".fl-ex-money-avg").html(parseFloat(Math.round(d.max/d.avg * 100) / 100).toFixed(2)+ "x")
			      	$(".fl-chp-money").html("$" +numberWithCommas(d.min))
			      	$(".fl-chp-money-avg").html(parseFloat(Math.round(d.min/d.avg * 100) / 100).toFixed(2) + "x")
			      	$(".fl-ex-pay").html("$" +numberWithCommas(d.medipay_max))
			      	$(".fl-ex-pay-avg").html(parseFloat(Math.round(d.medipay_max/d.medipay_avg * 100) / 100).toFixed(2) + "x")
			      	$(".fl-chp-pay").html("$" +numberWithCommas(d.medipay_min))
			      	$(".fl-chp-pay-avg").html(parseFloat(Math.round(d.medipay_min/d.medipay_avg * 100) / 100).toFixed(2)  + "x")
		      	})
		      	.on("mouseout",function(d,i){
		      		$(this).removeClass("highlight")
		      	})

			
	} //end of draw giant chart

	function paintCht(){
			
			d3.selectAll(".bar")
				.transition()
		      .delay(function(d,i){return i *7})
				.style("fill", function(d,i){
		      	      	if(d.max/d.min >=20){
		      	      		return color(0);
		      	      	}else if (d.max/d.min >=10 && d.max/d.min <20){
		      	      		return color(1);
		      	      	} else if (d.max/d.min<10 && d.max/d.min >5){
		      	      		return color(2);
		      	      	}else if (d.max/d.min <= 5 && d.max/d.min >3){
		      	      		return color(3)
		      	      	}else{
		      	      		return color(4)
		      	      	}
		      		})
	}

	function drawAvgline(){
			svg.selectAll("line_avg")
					.data(myData)
					.enter().append("line")
					.attr("class","avg_line")
					.attr("y1",function(d){return y(d.DRG)})
					.attr("x1", 0)
					.attr("y2",function(d){return y(d.DRG) +y.rangeBand();})
					.attr("x2", 0)
					.transition()
				    .delay(function(d,i){return i *7})
					.attr("y1",function(d){return y(d.DRG)})
					.attr("x1", function(d) { return x(d.avg); })
					.attr("y2",function(d){return y(d.DRG) +y.rangeBand();})
					.attr("x2", function(d) { return x(d.avg); })
					.attr("stroke-width", 3)
					.attr("stroke", "#073596");
	}




	function drawAvgcht(){

		var margin = {top: 10, right: 10, bottom: 70, left: 10},
		    width = 200 - margin.left - margin.right,
		    height = 300 - margin.top - margin.bottom;

		var x = d3.scale.ordinal().rangeRoundBands([0, width], .05);

		var y = d3.scale.linear().range([height, 0]);

		var xAxis = d3.svg.axis()
		    .scale(x)
		    .orient("bottom")

		var yAxis = d3.svg.axis()
		    .scale(y)
		    .orient("left")
		    .ticks(10);

		var svg = d3.select(".avg-cht").append("svg")
		    .attr("width", width + margin.left + margin.right)
		    .attr("height", height + margin.top + margin.bottom)
		  .append("g")
		    .attr("transform", 
		          "translate(" + margin.left + "," + margin.top + ")");
		
		function make_y_axis() {
		  return d3.svg.axis()
		      .scale(y)
		      .orient("left")
		      .ticks(5)
		}

		d3.tsv("data.tsv", function(error, data) {

		    data.forEach(function(d) {
		        d.value = +d.value;
		    });
			
		  x.domain(data.map(function(d) { return d.letter; }));
		  y.domain([0, d3.max(data, function(d) { return d.value; })]);

		  svg.append("g")
		      .attr("class", "x axis")
		      .attr("transform", "translate(0," + height + ")")
		      .call(xAxis)
		    .selectAll("text")
		      .style("text-anchor", "end")
		      .attr("dx", "-.8em")
		      .attr("dy", "-.55em")
		      .attr("transform", "rotate(-90)" );

		  svg.append("g")
		      .attr("class", "y axis")
		      .call(yAxis)
		    .append("text")
		      .attr("transform", "rotate(-90)")
		      .attr("y", 6)
		      .attr("dy", ".71em")
		      .style("text-anchor", "end")
		      .text("Value ($)");

		  svg.selectAll("bar")
		      .data(data)
		    .enter().append("rect")
		      .style("fill", "steelblue")
		      .attr("x", function(d) { return x(d.letter); })
		      .attr("width", x.rangeBand())
		      .attr("y", function(d) { return y(d.value); })
		      .attr("height", function(d) { return height - y(d.value); });

		   svg.append("g")            
		        .attr("class", "grid")
		        .call(make_y_axis()
		            .tickSize(-width, 0, 0)
		            .tickFormat("")
		        )

		}); //end of data closure
	}//end of drawAvgcht

	function resizeChart(){

	}

	return {
		"draw": drawChart,
		"resize":resizeChart,
		"avgchart":drawAvgcht,
		"avgline":drawAvgline,
		"paintcht":paintCht,
		 }
}

var graphA = Graph(true);
graphA.avgchart();

// window.on("resize", graphA.resize);



var waypoint = new Waypoint({
  element: document.getElementById('section2'),
  handler: function(direction) {
  	if(direction == "down"){
    		graphA.avgline();
          }else{
            d3.select(".giant_chart").selectAll(".avg_line").remove()

          }
  },
  offset:'50%'
})	

var waypoint2 = new Waypoint({
  element: document.getElementById('section3'),
  handler: function(direction) {
  	if(direction == "down"){
			graphA.paintcht();
          }else{
            d3.selectAll(".bar").style("fill","lightgrey")
          }
  },
  offset:'50%'

})

	
d3.csv("data.csv", function(error, data){
	for (var i = 0; i < data.length; i++){
		$('.occ-name').append('<option value=' + data[i].ID+ ' >' + data[i].DRG + '</option>');
		// console.log(data[i].DRG);
	}
})

$(".chosen").chosen({
    width: "100%",
    allow_single_deselect: true
});


$(".chosen").trigger("chosen:updated");

function numberWithCommas(x) {
    return x.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
}
</script>
</html>